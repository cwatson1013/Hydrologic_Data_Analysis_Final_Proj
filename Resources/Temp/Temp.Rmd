---
output: 
  pdf_document:
    fig_caption: yes
    number_sections: yes
header-includes:
 \usepackage{float}
geometry: margin=2.54cm
title: "Examining the Hydrologic Properties of the Missouri River Basin"
subtitle: "https://github.com/cwatson1013/Hydrologic_Data_Analysis_Final_Proj"
author: "Rachel Bash, Keqi He, Caroline Watson, and Haoyu Zhang"
fontsize: 12pt
mainfont: Times New Roman
editor_options: 
  chunk_output_type: console
bibliography: reference.bib
---

\newpage


```{r setup, include=FALSE}
knitr::opts_chunk$set(message=FALSE, warning=FALSE, echo=FALSE, fig.pos="H")
# Set your working directory
getwd()

# Load your packages
library(tidyverse)
library(kableExtra)
library(dataRetrieval)
library(dplyr)
library(xts)
library(dygraphs)
library(lubridate)
library(gridExtra)
library(cowplot)
library(trend)
library(forecast)
library(tseries)
library(jpeg)
library(grid)
library(gridExtra)
library(ggpubr)
require(pander)

# Set your ggplot theme

theme_set(theme_classic())

# Load your datasets

```

# Rationale and Research Questions

The Missouri River is the largest river in North America (2,540 miles) and has the second largest watershed spanning 529,000 mi^2^ ([@kammerer1990]). Its watershed covers portions of ten states, which account for approximately one-sixth of the continental United States, as well as a small part of Canada [@usace2018]. The headwater is located in the Bitterroot Mountains River of northwestern Wyoming and southwestern Montana [@nrc2002]. The basin is primarily rural, but also has several large and medium-sized cities. In 2012, the basin was home to approximately 15.5 million people, and many large cities in the region are in proximity to the Missouri River [@usace2018]. Demands for managing the river for the benefit of human livelihood has resulted in drastic modification in the river and the floodplains. Numerous reservoirs and dams have been constructed, of which six major dams were built on the mainstream [@nrc2002]. Now, the river is used intensively in multiple ways, including municipal, agricultural, hydropower, recreation, flood control etc. [@bor2016-1].

Within the 328 million acres of the basin’s total area in the United States, 64.2% are related to agricultural uses, while the rest are dedicated for recreation, fish and wildlife, and urban development [@bor2016-1]. 37.1% of the total basin area is pasture and range grassland primarily for grazing, and cropland consists of almost 92 million acres [@usace2018]. As of 2012, irrigated land comprises 14.2 million acres, and require a delivery of about 13 million acre-feet of surface water annually [@usace2018]. Wetlands and water bodies, on the other hand, cover 3.7 and 1.8 million acres, respectively [@usace2018]. In spite of the low proportion of water areas (2.3%), they are the pivotal foundation for agricultural or other usages, and thus critical to the whole region’s economy. 

The agricultural, urban, and industrial development in the region inevitably causes nutrient loading and enrichment in water bodies, especially for nitrogen (N) and phosphorus (P). Agricultural input through fertilizer is the predominant anthropogenic source for nutrient in water bodies in the whole basin [@nrc2002]. Regardless of the major anthropogenic source, nutrient enrichment is considered nationally as one of the leading factors for water quality impairment. According to the Clean Water Act 303(d) lists (2015), more than 160 stream reaches or waterbodies were reported by USEPA to suffer nutrient-related impairment in 2015.

In addition to change in nutrient concentration, discharge appears to be highly variable in the basin, and both severe drought and flooding events have occurred in the basin regularly. For example, in the spring and summer of 2011, an unprecedented flooding event caused over \$2 billion damage and 5 fatalities, leading to FEMA disaster declaration made in all states along the Missouri River [@noaa2012]. During the flooding event, around 11,000 people evacuated from Minot, North Dakota owing to high water level in Souris River, which flooded 4,000 homes [@noaa2012]. In 2012, a drought struck the Central Great Plain, including the basin, and inflicted at least \$12 billion of agricultural loss before July, 2012 [@noaa2013]. Recently, another flooding event occurred in the spring of 2018, due to the months of January through May being the wettest period on record for the U.S.

Given all the background information above, we would like to know the current state of Missouri River and its tributaries, with a focus on the changing patterns in discharge and nutrient levels. Water bodies along the downstream are more likely to be impaired by nutrients accumulated from the upstream. Croplands and pastures, which can further load nutrients into streams, are distributed throughout the lower basin (\autoref{fig:cropland}). Therefore, in the present project, study sites were concentrated in the southeast of the whole Missouri Basin. By analyzing data retrieved from these sites, we first revealed the general yearly discharge pattern and changes in variability over years. Then we investigated how the dramatic change in discharge (i.e. water quantity) could potentially interact with nutrient enrichment (i.e. water quality). We examined a few specific flooding and drought events, during which changes in both water quality and quantity were well recorded, so that we could make inference on the interplay between quantity and quality. The effect of population on nutrient enrichment was also examined to illustrate potential non-agricultural impact from human activities. Finally, based on the pattern in the past and the best model we could fit, we attempted to predict the likely future conditions and trends in the Missouri River Basin. Our research questions and acccompanying hypotheses are below:

1. How have changes in discharge (i.e. water quantity) interacted with nutrient enrichment (i.e. water quality) in the Missouri River Basin?

    a) Nutrient levels have increased over time
    b) Discharge has become more variable over time 
    c) Nutrient levels increase with discharge 
  
 
2. What effects do specific flood and drought events have on the water quality and quantity of rivers in the Missouri River Basin areas of interest?

    a) Rivers will exhibit a flushing behavior due to the land use and type of flow during storms 
    b) Discharge will decrease during drought due to decreased overland flow. 
    
3. What factors contribute to the variability of total nitrogen in the rivers?

    a) Land use, year, discharge, phosphorus, and HUC region will contribute to the variability of total nitrogen across sites 

4. Given past and current data, what can we predict about the future state of water in the Missouri River Basin?

    a) Total flow in the Missouri River Basin is increasing (non-stationary) over time 
    b) The future situation of the river basin will see the continuation of current trends of increasing overall volume of flow. 

```{r cropland, out.width="\\maxwidth", fig.cap="\\label{fig:cropland} Map of agricultural lands and impaired waters in the Missouri River Basin. Row and Close Grain Crop Cultural Formation shown by tan-colored areas, pasture and hay field shown by yellowgreen areas, imparied water bodies according to Clean Water Act Section 303(d) (EPA 2015) denoted by red areas, and all HUC4 watersheds in the Missouri River Basin (1001-1030) delineated by gray polygons. The thin, light-blue lines outline all streams of a Strahler order higher than 2, and the thick blue line represents the mainstem of Missouri River."}
knitr::include_graphics('../../Figures/cropland3.png')
```

\newpage

# Dataset Information

The data we are analyzing comes from the United States Geological Survey (USGS) database called the National Water Information System interface, or NWIS. We pulled data from the interface using the R package `dataRetrieval`. Because we are interested in the southern part of the Missouri River basin, we pulled sites from each HUC4 subbasin from 1020 to 1030. We chose these subbasins because they had a variety of tributaries that all flowed into the Missouri River, representing a variety of river sizes and lengths. We filtered these subbasin queries to only show us sites that contained discharge, nitrogen, and phosphorus data. Once we found the sites with all of this data, we chose 2 sites from each HUC sub basin for a total of 22. We chose the two sites from each HUC sub basin by comparing the periods of records for each of our chosen variables and finding the sites with the longest periods of records. We chose to look at two sites per HUC region (for a total of 22) in order to maintain a digestible scope (\autoref{fig:sitemap}). We retrieved data on water quantity and water quality (N, P concentrations) (Table 1).

Only six sites within our HUC subbasin boundary contained any high frequency nitrogen data. Therefore, we also looked at these six sites in order to do analyses and answer our research question about flooding. Since flooding and droughts can be thought of as opposites, we looked at the same 6 sites for droughts as we did for flooding (Table x - add table??). 

We have two main datasets:

- The daily values dataset containing discharge, nitrogen, and phosphorus data for 22 sites. 

- The high freqency dataset containing high frequency data for nitrogen and discharge for 6 sites.



**Table 1:** Add title
Variable   |   Unit  |   Number of Sites   |   
----------- | :---------------: | --------------- |
Discharge  | cfs or $m^{3}$/s | 22 
Time | UTC | 22
Nitrogen | mg/L | 22 with daily values, 6 with high frequency values
Phosphorus | mg/L | 22

**Table 2:** Add table for date ranges and possibly sites used for flooding?


```{r sitemap, out.width="\\maxwidth", fig.cap="\\label{fig:sitemap} Map of USGS sites used for long term analysis."}
knitr::include_graphics("../../Figures/site_map.png")
```

\newpage

# Exploratory Analysis 

## Exploration of variables

Basic data wrangling was needed in order to obtain all variables of interest. After obtaining all pertinent data, each variable was visualized in order to see the shape of the data and the range of values (\autoref{fig:Nhist}). Any necessary transformation or cleaning was completed after this step.

```{r Nhist, out.width="\\maxwidth", fig.cap="\\label{fig:Nhist} Histograms showing the range of total nitrogen values obtained from all sites during the total period of record. Raw (left) and logged (right) nitrogen data are shown to show that any analysis requiring normally distributed data will use the log transformed nitrogen data."}
knitr::include_graphics("../../Figures/Nitrogenhist.png")
```

Discharge, nitrogen, and phosphorus were plotted for each site and examined together in order to see if there were any obvious patterns or trends (\autoref{fig:dataexample}).

```{r dataexample, echo=FALSE, warning=FALSE, out.width="\\maxwidth", fig.cap="\\label{fig:dataexample} Discharge, Nitrogen, Phosphorus daily data of Site No. 22, the  Missouri River At Hermann, MO."}

## Discharge
MRHDischarge <- readNWISdv(siteNumbers = "06934500",
                             parameterCd = "00060", # discharge (ft3/s)
                             startDate = "",
                             endDate = "")
names(MRHDischarge)[4:5] <-c("Discharge", "Approval.Code")

# Plot discharge over time
MRHPlot <- 
  ggplot(MRHDischarge, aes(x = Date, y = Discharge/10^5)) +
  geom_line() +
  labs(x = "", y = expression("Discharge (10"^5*" ft"^3*"/s)"), 
        title = "  22 Missouri River At Hermann, MO") + 
  xlim(as.Date(c("1928-01-01", "2020-01-01"))) 
  par(pin = c(50,40))

## Nitrogen
MRHNitrogen <- readNWISqw(siteNumbers = "06934500",
                            parameterCd = "00600", # nitrogen (mg/L)
                            startDate = "",
                            endDate = "") %>%
  select(sample_dt, result_va)

# What do these data look like?
MRHN <-
  ggplot(MRHNitrogen, aes(x = sample_dt, y = result_va)) +
  geom_point()

# Remove outliers
MRHNitrogen <- MRHNitrogen %>%
  filter(result_va < 10) %>%
  arrange(sample_dt)

# Re-plot data
MRHN <-
  ggplot(MRHNitrogen, aes(x = sample_dt, y = result_va)) +
  geom_line() +
  labs(x = " ", y = expression("Nitrogen (mg/L)")) +
  xlim(as.Date(c("1928-01-01", "2020-01-01"))) 

## Phosphorus
MRHPhosphorus <- readNWISqw(siteNumbers = "06934500",
                              parameterCd = "00665", # phosphorus (mg/L)
                              startDate = "",
                              endDate = "") %>%
  select(sample_dt, result_va)

# What do these data look like?
MRHP <-
  ggplot(MRHPhosphorus, aes(x = sample_dt, y = result_va)) +
  geom_point()

# Remove outliers
MRHPhosphorus <- MRHPhosphorus %>%
  filter(result_va < 3) %>%
  arrange(sample_dt)

# Re-plot data
MRHP <-
  ggplot(MRHPhosphorus, aes(x = sample_dt, y = result_va)) +
  geom_line() +
  labs(x = "Date", y = expression("Phosphorus (mg/L)"))  +
  xlim(as.Date(c("1928-01-01", "2020-01-01"))) 

ggarrange(MRHPlot, MRHN, MRHP
          + font("x.text", size = 10), ncol = 1, nrow = 3)
```

## Yearly Discharge Pattern

Typical discharge patterns within a year for each HUC4 watershed from 1020 to 1030 were generated by compiling all available discharge data at the 22 selected USGS site (\autoref{fig:dispattern}). Generally, discharge reaches its peak during the summer and falls to minima during the winter, and most of the sites exhibit rather high variations across years, as indicated by the large difference between the medians and the first or the third quartiles. Furthermore, highest variations in discharge appear to occur in the summer, whereas discharge in the winter varies less among years. The large variability within a year and the seasonal pattern is only obvious in larger streams and rivers but not in small creeks (e.g. site 5 Maple Creek near Nickerson, site 8 Boyer River, site 21 Small Blue River). 
Exceptions to the generalization are three sites with medium discharge (site 1 Platte River, NE; site 3 Dismal River, NE; site 11 Republican River, NE). They have fairly constant discharge and variation across years, and the the first and the third even have slightly lower discharge during the summer. Platte River forms by the confluence of North Platte and South Platte Rivers, and both two have snowmelt as their water source, resulting in the observed higher discharge during the spring and low in the summer. Dismal River forms by two forks that arise from groundwater (Ogallala Aquifer), which is supposed to be more stable than precipitation. The majority of Republican River basin is underlain by Ogallala Aquifer [@bor2016-2], and a plausible high proportion of water source from groundwater could explain the little variation across years.

```{r dispattern, out.width="\\maxwidth", fig.cap="\\label{fig:dispattern}Yearly discharge pattern for the lower Missouri HUC4 watersheds. Thick, solid, and dark lines are the median of all discharge records on a day of year, while thin, dashed, and light lines are the 25th and 75th discharge quantiles on that day. The blue lines represent the first site in a HUC4 watershed, while the green lines represent the second site."}
knitr::include_graphics('../../Figures/discharge.jpg')
```

## Change in Discharge Variations over Years
To reveal how variability of discharge has changed over time, we analyzed the relationship between standard deviation (SD) of discharge within a year and years, using linear models (\autoref{fig:varfig}; \autoref{tab:vartab}). Among all the 22 sites, 14 sites suggest increasing SD over time, and 4 of them show statistically significant increase. By contrast, only 8 sites suggest declining SD trends, and 2 of them exhibit statistically significant rising in SD. Despite that only data from six sites (around 27%) yield conclusive results, within these sites the number of streams that have become more variable are two times as many as those with decreasing variability. Thus, our results suggest that the whole Missouri Basin appear to have become more variable over years since around the mid-19th century. The low percentage of significant results could result from the small effect size, and/or the short time span of available data for some sites. Hence, more monitoring on discharge in the basin are required in the future to reach a more definitive conclusion.

```{r varfig, echo=FALSE, warning=FALSE, out.width="\\maxwidth", fig.cap="\\label{fig:varfig} Changes in the standard deviations (SD) of discharge within a year at 22 sites over the whole time span of available data. Red regression lines and confidence intervals suggest increasing SD, whereas blue for decreasing SD over time. Bolded site labels and HUC8 with asterisk indicate significant results, whereas regression lines in gray are non-significant ($\\alpha = 0.05$)."}
knitr::include_graphics('../../Figures/sd_year.png')
```

```{r vartab, echo=FALSE, out.width="\\maxwidth", eval=TRUE, results="asis"}
sd.table <- read.csv("../../Data/Processed/sd_year.csv")
cv.table <- read.csv("../../Data/Processed/cv_year.csv")
tab1 <- left_join(sd.table, cv.table[,c("site_nm","slope", "p")], 
                   by = "site_nm", suffix = c(".sd", ".cv"))
# add significance note
tab <- tab1 %>% 
  mutate(p.sd = case_when(p.sd < 0.001 ~ paste0(format(base::round(p.sd, 3), digits = 3), "***"),
                          p.sd < 0.01 ~ paste0(format(base::round(p.sd, 3), digits = 3), "**"),
                          p.sd < 0.05 ~ paste0(format(base::round(p.sd, 3), digits = 3), "*"),
                          TRUE ~ as.character(format(base::round(p.cv, 3), digits = 3))),
         p.cv = case_when(p.cv < 0.001 ~ paste0(format(base::round(p.cv, 3), digits = 3), "***"),
                          p.cv < 0.01 ~ paste0(format(base::round(p.cv, 3), digits = 3), "*"),
                          p.cv < 0.05 ~ paste0(format(base::round(p.cv, 3), digits = 3), "*"),
                          TRUE ~ as.character(format(base::round(p.cv, 3), digits = 3))))

kable(tab, format = "latex", booktabs = T,
      col.names = c("No.","Site Name", "HUC4","Slope","$P$-value", "Slope","$P$-value"), escape = FALSE,
      align = c("r", "c", "c", "c", "c", "c", "c"),
      caption = "\\label{tab:vartab} Slopes of linear regression between year and standard deviation or coefficient of variation of discharge at 22 sites.") %>%
  footnote() %>%
  kable_styling(latex_options = c("striped", "scale_down", "HOLD_position")) %>%
  add_header_above(header = c(" " = 3,"Standard Deviation" = 2,"Coefficient of Variation" = 2)) %>%
  footnote(general = "Significance level",
           symbol = c("<0.05;", "<0.01;", "<0.001;"),
           symbol_manual = c("*", "**", "***"))

# #####
# panderOptions("digits", c(1, 0, 4, 3, 3, 3, 3))
# panderOptions("table.split.table", Inf)
# emphasize.strong.cells(which(var.table$p < 0.05, arr.ind = TRUE))
# set.alignment(c("right", "centre", "center", "center", "center", "center", "center"))
# 
# pandoc.table(tab, style = 'rmarkdown',
#              col.names = c("No.","Site Name", "HUC4","Slope","*P*-value", "Slope","*P*-value"),
#              caption = "\\label{tab:vartab} Slopes of linear regression between year and standard deviation or coefficient of variation of discharge at 22 sites.") %>%
# #####
```

# References

