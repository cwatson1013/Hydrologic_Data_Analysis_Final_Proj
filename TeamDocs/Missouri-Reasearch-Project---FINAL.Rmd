---
output: 
  pdf_document:
    fig_caption: yes
    number_sections: yes
header-includes:
 \usepackage{float}
geometry: margin=2.54cm
title: "Examining the Hydrologic Properties of the Missouri River Basin"
subtitle: "https://github.com/cwatson1013/Hydrologic_Data_Analysis_Final_Proj"
author: "Rachel Bash, Keqi He, Caroline Watson, and Haoyu Zhang"
fontsize: 12pt
mainfont: Times New Roman
editor_options: 
  chunk_output_type: console
bibliography: reference.bib
---

\newpage


```{r setup, include=FALSE}
knitr::opts_chunk$set(message=FALSE, warning=FALSE, echo=FALSE, fig.pos="H")
# Set your working directory
getwd()

# Load your packages
library(tidyverse)
library(kableExtra)
library(dataRetrieval)
library(xts)
library(dygraphs)
library(lubridate)
library(gridExtra)
library(cowplot)
library(trend)
library(forecast)
library(tseries)
library(grid)
library(gridExtra)
library(ggpubr)
require(pander)

# Set your ggplot theme
theme_set(theme_classic())

# Load your datasets


```

# Rationale and Research Questions

The Missouri River is the largest river in North America (2,540 miles) and has the second largest watershed spanning 529,000 mi^2^ ([@kammerer1990]). Its watershed covers portions of ten states, which account for approximately one-sixth of the continental United States, as well as a small part of Canada [@usace2018]. The headwater is located in the Bitterroot Mountains River of northwestern Wyoming and southwestern Montana [@nrc2002]. The basin is primarily rural, but also has several large and medium-sized cities. In 2012, the basin was home to approximately 15.5 million people, and many large cities in the region are in proximity to the Missouri River [@usace2018]. Demands for managing the river for the benefit of human livelihood has resulted in drastic modification in the river and the floodplains. Now, the river is used intensively in multiple ways, including municipal, agricultural, hydropower, recreation, flood control etc. [@bor2016-1].

Within the 328 million acres of the basin’s total area in the United States, 64.2% are related to agricultural uses, while the rest are dedicated for recreation, fish and wildlife, and urban development [@bor2016-1]. 37.1% of the total basin area is pasture and range grassland primarily for grazing, and cropland consists of almost 92 million acres [@usace2018]. As of 2012, irrigated land comprises 14.2 million acres, and require a delivery of about 13 million acre-feet of surface water annually [@usace2018]. Wetlands and water bodies, on the other hand, cover 3.7 and 1.8 million acres, respectively [@usace2018]. In spite of the low proportion of water areas (2.3%), they are the pivotal foundation for agricultural or other usages, and thus critical to the whole region’s economy. 

The agricultural, urban, and industrial development in the region inevitably causes nutrient loading and enrichment in water bodies, especially for nitrogen (N) and phosphorus (P). Agricultural input through fertilizer is the predominant anthropogenic source for nutrient in water bodies in the whole basin [@nrc2002]. Regardless of the major anthropogenic source, nutrient enrichment is considered nationally as one of the leading factors for water quality impairment. According to the Clean Water Act 303(d) lists (2015), more than 160 stream reaches or waterbodies were reported by USEPA to suffer nutrient-related impairment in 2015.

In addition to change in nutrient concentration, discharge appears to be highly variable in the basin, and both severe drought and flooding events have occurred in the basin regularly. For example, in the spring and summer of 2011, an unprecedented flooding event caused over \$2 billion damage and 5 fatalities, leading to FEMA disaster declaration made in all states along the Missouri River [@noaa2012]. During the flooding event, around 11,000 people evacuated from Minot, North Dakota owing to high water level in Souris River, which flooded 4,000 homes [@noaa2012]. In 2012, a drought struck the Central Great Plain, including the basin, and inflicted at least \$12 billion of agricultural loss before July, 2012 [@noaa2013]. Recently, another flooding event occurred in the spring of 2018, due to the months of January through May being the wettest period on record for the U.S.

Given all the background information above, we would like to know the current state of Missouri River and its tributaries, with a focus on the changing patterns in discharge and nutrient levels. Water bodies along the downstream are more likely to be impaired by nutrients accumulated from the upstream. Croplands and pastures, which can further load nutrients into streams, are distributed throughout the lower basin (\autoref{fig:cropland}). Therefore, in the present project, study sites were concentrated in the southeast of the whole Missouri Basin. By analyzing data retrieved from these sites, we first revealed the general yearly discharge pattern and changes in variability over years. Then we investigated how the dramatic change in discharge (i.e. water quantity) could potentially interact with nutrient enrichment (i.e. water quality). We examined a few specific flooding and drought events, during which changes in both water quality and quantity were well recorded, so that we could make inference on the interplay between quantity and quality. The effect of population on nutrient enrichment was also examined to illustrate potential non-agricultural impact from human activities. Finally, based on the pattern in the past and the best model we could fit, we attempted to predict the likely future conditions and trends in the Missouri River Basin. Our research questions and acccompanying hypotheses are below:

1. How have changes in discharge (i.e. water quantity) interacted with nutrient enrichment (i.e. water quality) in the Missouri River Basin?

    a) Nutrient levels have increased over time
    b) Discharge has become more variable over time 
    c) Nutrient levels increase with discharge 
  
 
2. What effects do specific flood and drought events have on the water quality and quantity of rivers in the Missouri River Basin areas of interest?

    a) Rivers will exhibit a flushing behavior due to the land use and type of flow during storms 
    b) Discharge will decrease during drought due to decreased overland flow. 
    
3. What factors contribute to the variability of total nitrogen in the rivers?

    a) Land use, year, discharge, phosphorus, and HUC region will contribute to the variability of total nitrogen across sites 

4. Given past and current data, what can we predict about the future state of water in the Missouri River Basin?

    a) Total flow in the Missouri River Basin is increasing (non-stationary) over time 
    b) The future situation of the river basin will see the continuation of current trends of increasing overall volume of flow. 

```{r cropland, out.width="\\maxwidth", fig.cap="\\label{fig:cropland} Map of agricultural lands and impaired waters in the Missouri River Basin. Row and Close Grain Crop Cultural Formation shown by tan-colored areas, pasture and hay field shown by yellowgreen areas, imparied water bodies according to Clean Water Act Section 303(d) (EPA 2015) denoted by red areas, and all HUC4 watersheds in the Missouri River Basin (1001-1030) delineated by gray polygons. The thin, light-blue lines outline all streams of a Strahler order higher than 2, and the thick blue line represents the mainstem of Missouri River."}
knitr::include_graphics('../Figures/cropland3.png')
```

\newpage

# Dataset Information

The data we are analyzing comes from the United States Geological Survey (USGS) database called the National Water Information System interface, or NWIS. We pulled data from the interface using the R package `dataRetrieval`. Because we are interested in the southern part of the Missouri River basin, we pulled sites from each HUC4 subbasin from 1020 to 1030. We chose these subbasins because they had a variety of tributaries that all flowed into the Missouri River, representing a variety of river sizes and lengths. We filtered these subbasin queries to only show us sites that contained discharge, nitrogen, and phosphorus data. Once we found the sites with all of this data, we chose 2 sites from each HUC sub basin for a total of 22. We chose the two sites from each HUC sub basin by comparing the periods of records for each of our chosen variables and finding the sites with the longest periods of records. We chose to look at two sites per HUC region (for a total of 22) in order to maintain a digestible scope (\autoref{fig:sitemap}). We retrieved data on water quantity and water quality (N, P concentrations) (Table 1).

Only six sites within our HUC subbasin boundary contained any high frequency nitrogen data. Therefore, we also looked at these six sites in order to do analyses and answer our research question about flooding. Since flooding and droughts can be thought of as opposites, we looked at the same 6 sites for droughts as we did for flooding (Table x - add table??). 

We have two main datasets:

- The daily values dataset containing discharge, nitrogen, and phosphorus data for 22 sites. 

- The high freqency dataset containing high frequency data for nitrogen and discharge for 6 sites.



**Table 1:** Add title
Variable   |   Unit  |   Number of Sites   |   
----------- | :---------------: | --------------- |
Discharge  | cfs or $m^{3}$/s | 22 
Time | UTC | 22
Nitrogen | mg/L | 22 with daily values, 6 with high frequency values
Phosphorus | mg/L | 22

**Table 2:** Add table for date ranges and possibly sites used for flooding?


```{r sitemap, out.width="\\maxwidth", fig.cap="\\label{fig:sitemap} Map of USGS sites used for long term analysis."}
knitr::include_graphics("../Figures/site_map.png")
```

\newpage

# Exploratory Analysis 

## Exploration of variables

Basic data wrangling was needed in order to obtain all variables of interest. After obtaining all pertinent data, each variable was visualized in order to see the shape of the data and the range of values (\autoref{fig:Nhist}). Any necessary transformation or cleaning was completed after this step.

```{r Nhist, out.width="\\maxwidth", fig.cap="\\label{fig:Nhist} Histograms showing the range of total nitrogen values obtained from all sites during the total period of record. Raw (left) and logged (right) nitrogen data are shown to show that any analysis requiring normally distributed data will use the log transformed nitrogen data."}
knitr::include_graphics("../Figures/Nitrogenhist.png")
```

Discharge, nitrogen, and phosphorus were plotted for each site and examined together in order to see if there were any obvious patterns or trends (\autoref{fig:dataexample}).

```{r dataexample, echo=FALSE, warning=FALSE, out.width="\\maxwidth", fig.cap="\\label{fig:dataexample} Discharge, Nitrogen, Phosphorus daily data of Site No. 22, the  Missouri River At Hermann, MO."}

## Discharge
MRHDischarge <- readNWISdv(siteNumbers = "06934500",
                             parameterCd = "00060", # discharge (ft3/s)
                             startDate = "",
                             endDate = "")
names(MRHDischarge)[4:5] <-c("Discharge", "Approval.Code")

# Plot discharge over time
MRHPlot <- 
  ggplot(MRHDischarge, aes(x = Date, y = Discharge/10^5)) +
  geom_line() +
  labs(x = "", y = expression("Discharge (10"^5*" ft"^3*"/s)"), 
        title = "  22 Missouri River At Hermann, MO") + 
  xlim(as.Date(c("1928-01-01", "2020-01-01"))) 
  par(pin = c(50,40))

## Nitrogen
MRHNitrogen <- readNWISqw(siteNumbers = "06934500",
                            parameterCd = "00600", # nitrogen (mg/L)
                            startDate = "",
                            endDate = "") %>%
  select(sample_dt, result_va)

# What do these data look like?
MRHN <-
  ggplot(MRHNitrogen, aes(x = sample_dt, y = result_va)) +
  geom_point()

# Remove outliers
MRHNitrogen <- MRHNitrogen %>%
  filter(result_va < 10) %>%
  arrange(sample_dt)

# Re-plot data
MRHN <-
  ggplot(MRHNitrogen, aes(x = sample_dt, y = result_va)) +
  geom_line() +
  labs(x = " ", y = expression("Nitrogen (mg/L)")) +
  xlim(as.Date(c("1928-01-01", "2020-01-01"))) 

## Phosphorus
MRHPhosphorus <- readNWISqw(siteNumbers = "06934500",
                              parameterCd = "00665", # phosphorus (mg/L)
                              startDate = "",
                              endDate = "") %>%
  select(sample_dt, result_va)

# What do these data look like?
MRHP <-
  ggplot(MRHPhosphorus, aes(x = sample_dt, y = result_va)) +
  geom_point()

# Remove outliers
MRHPhosphorus <- MRHPhosphorus %>%
  filter(result_va < 3) %>%
  arrange(sample_dt)

# Re-plot data
MRHP <-
  ggplot(MRHPhosphorus, aes(x = sample_dt, y = result_va)) +
  geom_line() +
  labs(x = "Date", y = expression("Phosphorus (mg/L)"))  +
  xlim(as.Date(c("1928-01-01", "2020-01-01"))) 

ggarrange(MRHPlot, MRHN, MRHP
          + font("x.text", size = 10), ncol = 1, nrow = 3)
```

## Yearly Discharge Pattern

Typical discharge patterns within a year for each HUC4 watershed from 1020 to 1030 were generated by compiling all available discharge data at the 22 selected USGS site (\autoref{fig:dispattern}). Generally, discharge reaches its peak during the summer and falls to minima during the winter, and most of the sites exhibit rather high variations across years, as indicated by the large difference between the medians and the first or the third quartiles. Furthermore, highest variations in discharge appear to occur in the summer, whereas discharge in the winter varies less among years. The large variability within a year and the seasonal pattern is only obvious in larger streams and rivers but not in small creeks (e.g. site 5 Maple Creek near Nickerson, site 8 Boyer River, site 21 Small Blue River). 
Exceptions to the generalization are three sites with medium discharge (site 1 Platte River, NE; site 3 Dismal River, NE; site 11 Republican River, NE). They have fairly constant discharge and variation across years, and the the first and the third even have slightly lower discharge during the summer. Platte River forms by the confluence of North Platte and South Platte Rivers, and both two have snowmelt as their water source, resulting in the observed higher discharge during the spring and low in the summer. Dismal River forms by two forks that arise from groundwater (Ogallala Aquifer), which is supposed to be more stable than precipitation. The majority of Republican River basin is underlain by Ogallala Aquifer [@bor2016-2], and a plausible high proportion of water source from groundwater could explain the little variation across years.

```{r dispattern, out.width="\\maxwidth", fig.cap="\\label{fig:dispattern}Yearly discharge pattern for the lower Missouri HUC4 watersheds. Thick, solid, and dark lines are the median of all discharge records on a day of year, while thin, dashed, and light lines are the 25th and 75th discharge quantiles on that day. The blue lines represent the first site in a HUC4 watershed, while the green lines represent the second site."}
knitr::include_graphics('../Figures/discharge.jpg')
```

## Change in Discharge Variations over Years
To reveal how variability of discharge has changed over time, we analyzed the relationship between standard deviation (SD) of discharge within a year and years, using linear models (\autoref{fig:varfig}; \autoref{tab:vartab}). Among all the 22 sites, 14 sites suggest increasing SD over time, and 4 of them show statistically significant increase. By contrast, only 8 sites suggest declining SD trends, and 2 of them exhibit statistically significant rising in SD. Despite that only data from six sites (around 27%) yield conclusive results, within these sites the number of streams that have become more variable are two times as many as those with decreasing variability. Thus, our results suggest that the whole Missouri Basin appear to have become more variable over years since around the mid-19th century. The low percentage of significant results could result from the small effect size, and/or the short time span of available data for some sites. Hence, more monitoring on discharge in the basin are required in the future to reach a more definitive conclusion.

```{r varfig, echo=FALSE, warning=FALSE, out.width="\\maxwidth", fig.cap="\\label{fig:varfig} Changes in the standard deviations (SD) of discharge within a year at 22 sites over the whole time span of available data. Red regression lines and confidence intervals suggest increasing SD, whereas blue for decreasing SD over time. Bolded site labels and HUC8 with asterisk indicate significant results, whereas regression lines in gray are non-significant ($\\alpha = 0.05$)."}
knitr::include_graphics('../Figures/sd_year.png')
```

```{r vartab, echo=FALSE, out.width="\\maxwidth", eval=TRUE, results="asis"}
sd.table <- read.csv("../Data/Processed/sd_year.csv")
cv.table <- read.csv("../Data/Processed/cv_year.csv")
tab1 <- left_join(sd.table, cv.table[,c("site_nm","slope", "p")], 
                   by = "site_nm", suffix = c(".sd", ".cv"))
# add significance note
tab <- tab1 %>% 
  mutate(p.sd = case_when(p.sd < 0.001 ~ paste0(format(round(p.sd, 3), digits = 3), "***"),
                          p.sd < 0.01 ~ paste0(format(round(p.sd, 3), digits = 3), "**"),
                          p.sd < 0.05 ~ paste0(format(round(p.sd, 3), digits = 3), "*"),
                          TRUE ~ as.character(format(round(p.cv, 3), digits = 3))),
         p.cv = case_when(p.cv < 0.001 ~ paste0(format(round(p.cv, 3), digits = 3), "***"),
                          p.cv < 0.01 ~ paste0(format(round(p.cv, 3), digits = 3), "*"),
                          p.cv < 0.05 ~ paste0(format(round(p.cv, 3), digits = 3), "*"),
                          TRUE ~ as.character(format(round(p.cv, 3), digits = 3))))

kable(tab, format = "latex", booktabs = T,
      col.names = c("No.","Site Name", "HUC4","Slope","$P$-value", "Slope","$P$-value"), escape = FALSE,
      align = c("r", "c", "c", "c", "c", "c", "c"),
      caption = "\\label{tab:vartab} Slopes of linear regression between year and standard deviation or coefficient of variation of discharge at 22 sites.") %>%
  footnote() %>%
  kable_styling(latex_options = c("striped", "scale_down", "hold_position")) %>%
  add_header_above(header = c(" " = 3,"Standard Deviation" = 2,"Coefficient of Variation" = 2)) %>%
  footnote(general = "Significance level",
           symbol = c("<0.05;", "<0.01;", "<0.001;"),
           symbol_manual = c("*", "**", "***"))
```

\newpage
# Analysis

<Insert visualizations and text describing your main analyses. Format your R chunks so that graphs are displayed but code and other output is not displayed. Instead, describe the results of any statistical tests in the main text (e.g., "Variable x was significantly different among y groups (ANOVA; df = 300, F = 5.55, p < 0.0001)"). Each paragraph, accompanied by one or more visualizations, should describe the major findings and how they relate to the question and hypotheses. Divide this section into subsections, one for each research question.>

<Each figure should be accompanied by a caption, and each figure should be referenced within the text>


## Question 1:  How have changes in discharge interacted with nutrient enrichment in the Missouri River Basin?

We analyzed nitrogen and phosphorus trends at 22 sites using long-term daily value data and Seasonal Mann-Kendall Trend Test. The Seasonal Mann Kendall Trend Test is used to analyze seasonal data collected over time for consistently increasing or decreasing trends (monotonic) in Y values. It is suitable for analyzing the data with seasonality, non-parametric, no temporal autocorelation, identical distribution. 

The overall results of the analysis can be seen in the following table (Table 3).The trend of nitrogen and phosphorus concentration of 22 sites are quite different. Among all 22 sites, 7 sites show significantly increasing trends in nitrogen concentration, while 7 show decreasing trends. For phosphorus, concentrations at 7 sites have increased over time, while decreased at other 5 sites. But generally, the trend of nitrogen and the trend of phosphorus are similar, which indicates that there is a high possibility that nitrogen and phosphorus come from the same sources. Despite inconsistent results at all sites, those on the mainstem show higher nutrient concentration (No. 7 06610000 Missouri River at Omaha, NE; No. 10 06818000 Missouri River at St. Joseph, MO; No. 22 06934500 Missouri River at Hermann, MO), we can see a significant increasing trend of nitrogen and phosphorus. The water quality in Missouri River is still deteriorating and protection is urgently needed.

\newpage
Table: Nitrogen and Phosphorus Trend over Time for Every Site

No.    |   Site Number   |   Nitrogen Trend  |  Nitrogen Trend Significance  |   Phosphorus Trend    |  Phosphorus Trend Significance   |
:----------:|:-------:|:------------:|:----------:|:-------:|:------------:|
1  |  06768000  |  Decrease  |  *  |  Decrease  |  ***  |
2  |  06805500  |  Increase  |  ***  |  Increase  |  ***  |
3  |  06775900  |  Decrease  |  ***  |  Decrease  |    |
4  |  06794000  |  Increase  |    |  Increase  |    |
5  |  06800000  |  Increase  |  ***  |  Increase  |  ***  |
6  |  06800500  |  Increase  |  *  |  Increase  |    |
7  |  06610000  |  Increase  |  **  |  Increase  |  ***  |
8  |  06609500  |  Decrease  |    |  Increase  |    |
9  |  06810000  |  Decrease  |    |  Increase  |    |
10  |  06818000  |  Increase  |  .  |  Increase  |    |
11  |  06844500  |  Increase  |  .  |  Decrease  |  **  |
12  |  06856600  |  Decrease  |  **  |  Decrease  |  ***  |
13  |  06877600  |  Decrease  |  .  |  Increase  |    |
14  |  06874000  |  Decrease  |  ***  |  Decrease  |  ***  |
15  |  06887500  |  Increase  |  ***  |  Increase  |  ***  |
16  |  06892350  |  Increase  |  **  |  Increase  |  ***  |
17  |  06902000  |  Decrease  |  ***  |  Increase  |    |
18  |  06905500  |  Decrease  |    |  Increase  |    |
19  |  06921070  |  Decrease  |  .  |  Decrease  |    |
20  |  06926510  |  Decrease  |  ***  |  Increase  |  ***  |
21  |  06894000  |  Decrease  |  ***  |  Decrease  |  ***  |
22  |  06934500  |  Increase  |  ***  |  Increase  |  ***  |

Note:

'***' p-value < 0.001 

'**' 0.001 ≤ p-value < 0.01

'*' 0.01 <= p-value < 0.05 

'.' 0.05 <= p-value < 0.1 

otherwise  0.1 <= p-value < 1 

In order to determine whether nutrient levels increase with discharge, C-Q (concentration - discharge) plots were created for each site (\autoref{fig:CQplot}). At sites with high frequency nitrogen data, high frequency nitrogen and discharge values were used. When sites did not have high frequency nitrogen data, daily values were used. A linear model with total nitrogen as the response variable and discharge as the independent variable was created for every site to determine if there was a linear relationship between the two. In 18 out of 22 total sites, there was a significant relationship where as discharge increased, nitrogen also increased (p < 0.05). 
```{r CQplot, echo=FALSE, warning=FALSE, out.width="\\maxwidth", fig.cap="\\label{fig:CQplot} C-Q plots of two sites in the Missouri River Basin. High frequency (left) and daily values (right) shown for two different sites. Nitrogen values are log transformed."}  
knitr::include_graphics('../Figures/CQplots.png')
```

## Question 2: What effects do specific flood and drought events have on the water quality and quantity of rivers in the Missouri River Basin areas of interest?

### Flooding

Population of each county (from the 2010 census) in the four states that make up our region area of interest (Kansas, Nebraska, Missouri, and Iowa) were found using the "counties" database from R's `noncensus` package. We decided that population could be used as a proxy for land cover, as a greater population would indicate more development and fewer agricultural fields or open spaces. 

Baseflow and quickflow from each site were determined with the `EcoHydRology` package. After linearly interpolating the instantaneous discharge data in order to account for gaps, total baseflow volume was found and the percent of discharge exported as baseflow was calculated. We predicted that a site within a county with a large population would have a lower percent of its discharge exported as baseflow, because quickflow would be more common in areas with a lot of development. Similarly, we also predicted that a site within a county with a small population would have a greater percentage of its discharge coming from baseflow. More developed areas often have flashier floods, and so we were curious to see whether we can relate population to an element of flashiness - the percentage of discharge exported as quickflow.

Contrary to our hypotheses, greater county population does not contribute to a decrease in percent of discharge as baseflow (p = 0.4199, F = 0.8067) in our sites of interest. This may be due to our small sample size of sites, or perhaps the size of the rivers in our study.

High frequency nitrogen data was only available for six sites within our region. In order to better understand the behavior of rivers during floods, we examined dygraph plots of discharge and nitrogen, and created hysteresis plots. Storms from the fall of 2018 (September - December)  were examined for each river site with data from that time period. We chose to only look at storms that occurred in the second half of the year in order to avoid conflating snowpack melt and precipitation affects. 

We predicted that most rivers in the area would behave the same way, and that rivers would exhibit flushing behavior. We thought that flushing rivers would be more prevalent because of the many agricultural fields in our region of study, and any overland flow to the rivers would bring with it a high concentration of nutrients (nitrogen being one of them) from the fertilized fields. Our results say otherwise (Table 4). Our sites of interest had both positive and negative slopes in the hysteresis plots, and also exhibited both clockwise and counter clockwise directions of flow (\autoref{fig:Randolphstorm}). The same river was analyzed multiple times throughout the year, and even the same river showed different slopes and directions in the hysteresis plots for different storm events. 

```{r Randolphstorm, echo=FALSE, fig.cap="\\label{fig:Randolphstorm}Hyteresis plot for site in Randolph, IA that shows a negative slope (diluting behavior) in a counter clockwise direction."}
Randolph <- read.csv("../Data/Processed/Randolph.csv", as.is=TRUE)


RandolphStorm <- Randolph %>%
  filter(dateTime > "2018-10-07" & dateTime < "2018-10-13") 
RandolphStorm$dateTime <- as.Date(RandolphStorm$dateTime)


RandolphStorm.plot <- ggplot(RandolphStorm, aes(x = Flow_Inst, y = Nitrate_mgl, 
                                                color = dateTime)) +
  geom_point() +
  labs(x="Discharge (cfs)", y= "Nitrogen mg/l)", color="Date", 
       title="West Nishnabotna River in Randolph, IA")
print(RandolphStorm.plot)
```

Table: XXX

Site Name   |   Site Number   |   Time Period   |   Direction   |  Slope
----------- | :---------------: | --------------- | ------------- | ---------
West Nishnabotna River in Randolph, IA | 06808500  | Oct 7 - 13, 2018 | counter clockwise | negative (\autoref{fig:Randolphstorm})
Nodaway River at Clarinda, IA  | 06817000 | Oct 8 - 12, 2018 | clockwise | negative
Kansas River in Desoto, KS  | 06892350 |   Nov 30 - Dec 5, 2018 | counter clockwise | positive
Missouri River at Hermann, MO  | 06934500  |  Oct 7 - 20, 2018  | counter clockwise | negative
Mill C at Johnson Drive, Shawnee, KS  | 06892513 | Nov 27 - Dec 4, 2018 | clockwise | negative
Grand River, Sumner MO  | 06902000 |  Sep 6 - 10, 2018 | clockwise | positive

### Droughts
Droughts in the Missouri River Basin were known to occur throughout the years and six sites were analyzed for drought information. The six sites were chosen based off what was examined for floods. 

Drought was defined as determining the 7Q10, which is the minimum 7-day average flow that will occur every 10 years (probability of 10%) (EPA, 2019). The 7Q10 measurement is used to determine streamflow limits, allocate water resources, dilution rates in watersheds, and more (USGS, 2019). 7Q10 is calculated by determining the recurrence interval, which is the past recurrence of an event, which for droughts would be the minimum 7-day average discharge. The recurrence interval can then be used to calculate the probability, which would be the probability or likelihood of having a minimum 7-day average flow of this magnitude or greater. In this case, the minimum 7-day average flow that has a 10% chance of going below that  value in a given year. 

The recurrence interval is calculated using the following equation: 

$$T = (n+1)/m$$

where T is the recurrence interval, n is the number of years of data, and m is the ranking of the event within the years of data.

Exceedance probability is calculated to determine the probability of having a discharge event of a given size or greater in a year. The equation is: 

$$P = 1/T$$

where P is the exceedance probability, and T is the recurrence interval. 

The 7Q10 was calculated for each of the six sites by first filtering the discharge data to only include the selected site. The ‘rollmean’ function was then used to calculate the average flow every 7 days for said site. Once the 7-day average flow was calculated, the data was grouped by the year so that it could then be summarized to obtain the minimum 7-day average flow. After grouping and summarizing the data, there was one value, the minimum 7-day average flow, for each year of data obtained. From here, the recurrence interval and probability were calculated in each data frame. 

The miniumum 7 day average flow (cfs) for each river differed and the miniumum 7 day average low flow (cfs) varied from year to year in the same river (\autoref{fig:MinFlowMill}). 

```{r MinFlowMill, echo=FALSE, fig.cap="\\label{fig:MinFlowMill}Plot showing the minimum 7 day average flow (cfs) at Mill Creek for the period of record (October 2002 - November 2019). The miniumum 7 day average flow was very low in 2012 and decreased again in 2018."}

#compiling site numbers together for drought analysis
sites <- c("06808500", "06817000", "06892350", "06934500", "06892513", "06902000")

#reading in data for sites that were analyzed for floods to analyze discharge
site.dis <- readNWISdv(siteNumbers = c(sites),
                       parameterCd = "00060", #discharge
                       startDate = "",
                       endDate = "") %>%
  renameNWISColumns()

#filtering dataframe to get 7 day average and recurrence interval for 06892513 
avg.dis.Mill <- site.dis %>%
  filter(site_no == "06892513") %>%
  select(site_no, Date, Flow) %>%
  mutate(Year = year(Date),
         Month = month(Date), 
         Day = day(Date)) %>%
  arrange(Date) %>%
  mutate(rM = rollmean(Flow, 7, na.pad = TRUE, align = "center")) %>%
  na.omit() %>%
  group_by(Year) %>%
  summarise(MinDischarge = min(rM)) %>%
  mutate(Rank = rank(MinDischarge),
         RecurrenceInterval = (length(Year) + 1)/Rank,
         Probability = 1/RecurrenceInterval)

#plot of minimum 7 day average flow over time
sv.avg.plot.Mill <- ggplot(avg.dis.Mill, aes(x = Year, y = MinDischarge)) +
  geom_line(color = 'steelblue') +
  labs(x = "Year", y = "Minimum of 7 Day Average Flow (cfs)")
print(sv.avg.plot.Mill)

```

The 7Q10 value was then determined from the probability column by filtering the data to show the minimum 7-day average discharge with probability less than or equal to 0.1 (Table 3).

Table: WRITE caption summarizing the 7Q10 values for each of the streams that were analyzed for droughts.

Site Name   |   Site Number   |  7Q10 Minimum Discharge (cfs)  |     
----------- | --------------- | ------------------------------ |
West Nishnabotna River in Randolph, IA | 06808500  | 41.3
Nodaway River at Clarinda, IA  | 06817000 | 5.93
Kansas River in Desoto, KS  | 06892350 | 562   
Missouri River at Hermann, MO  | 06934500  | 12414
Mill C at Johnson Drive, Shawnee, KS  | 06892513 | 1.47
Grand River, Sumner MO  | 06902000 | 39.1  

In addition to calculating the 7Q10 values for the 6 sites, the sites were analyzed to determine the 30-day moving average flow over a period of years. This was done using code from USGS to calculate moving averages and historical quantiles (USGS, 2016). The 25th, 50th, and 75th quantiles were calculated to determine the minimum, median, and maximum values for discharge in a given year to determine historical flow. The 30-day moving average flow over a period of years was then plotted with Normal (25th to 75th percentile), Drought Watch (10th to 25th percentile), Drought Warning (5th to 10th percentile), and Drought Emergency (0 to 5th percentile) (\autoref{fig:Milldrought}). This information about what flow would constitute a drought is extremely useful for water managers.  

```{r Milldrought, echo=FALSE, fig.cap="\\label{fig:Milldrought}Plot showing the 30-day moving average of Mill Creek in 2017 and 2018 and whether it falls within a normal condition, drought watach condition, drought warning condition, or drought emergency condition. In March and April of 2017 and June, July, and August of 2018, Mill Creek was in a drought warning or drought emergency."}

options(scipen = 100)




#### Drought PLots for site Mill C at Johnson Drive, Shawnee, KS, # 06892513 ####

#reading in site info for 06892513 
stationInfo.Mill <- readNWISsite(siteNumber = "06892513")

#filtering for just one site and completing date sequence
site.dis.Mill <- site.dis %>%
  filter(site_no == "06892513")

#checking to see if there are missing dates in the dataframe
table(diff(site.dis.Mill$Date))

#Check for missing days, if so, add NA rows:
if(as.numeric(diff(range(site.dis.Mill$Date))) != (nrow(site.dis.Mill)+1)){
  fullDates.dis.Mill <- seq(from = min(site.dis.Mill$Date),
                              to = max(site.dis.Mill$Date), by="1 day")
  fullDates.dis.Mill <- data.frame(Date = fullDates.dis.Mill, 
                                     agency_cd = site.dis.Mill$agency_cd[1],
                                     site_no = site.dis.Mill$site_no[1],
                                     stringsAsFactors = FALSE)
  dailyQ.Mill <- full_join(site.dis.Mill, fullDates.dis.Mill,
                             by=c("Date","agency_cd","site_no")) %>%
    arrange(Date)
}


#calculating 30 day average
dailyQ.30.avg.Mill <- dailyQ.Mill %>%
  mutate(rM = rollmean(Flow, 30, na.pad = TRUE, align = "center"),
         day.of.year = as.numeric(strftime(Date, 
                                           format = "%j")))

#summarizing historical data
summaryQ.Mill <- dailyQ.30.avg.Mill %>%
  group_by(day.of.year) %>%
  summarize(p75 = quantile(rM, probs = .75, na.rm = TRUE),
            p25 = quantile(rM, probs = .25, na.rm = TRUE),
            p10 = quantile(rM, probs = 0.1, na.rm = TRUE),
            p05 = quantile(rM, probs = 0.05, na.rm = TRUE),
            p00 = quantile(rM, probs = 0, na.rm = TRUE)) 

#setting current year to 2018
current.year <- as.numeric(2018, format = "%Y") 

#summarizing data for 2017 - 2018
summary.0.Mill <- summaryQ.Mill %>%
  mutate(Date = as.Date(day.of.year - 1, 
                        origin = paste0(current.year-2,"-01-01")),
         day.of.year = day.of.year - 365)

#summarizing data for 2012 - 2015
summary.1.Mill <- summaryQ.Mill %>%
  mutate(Date = as.Date(day.of.year - 1, 
                        origin = paste0(current.year-1,"-01-01")))

#summarizing data for 2018 - 2020
summary.2.Mill <- summaryQ.Mill %>%
  mutate(Date = as.Date(day.of.year - 1, 
                        origin = paste0(current.year,"-01-01")),
         day.of.year = day.of.year + 365)

#putting data for 2017, 2018, and 2019 in one table
summaryQ.Mill <- bind_rows(summary.0.Mill, summary.1.Mill, summary.2.Mill) 

smooth.span <- 0.3

#predicting percentiles for 2017 -2019 low flow data
summaryQ.Mill$sm.75 <- predict(loess(p75~day.of.year, data = summaryQ.Mill, span = smooth.span))
summaryQ.Mill$sm.25 <- predict(loess(p25~day.of.year, data = summaryQ.Mill, span = smooth.span))
summaryQ.Mill$sm.10 <- predict(loess(p10~day.of.year, data = summaryQ.Mill, span = smooth.span))
summaryQ.Mill$sm.05 <- predict(loess(p05~day.of.year, data = summaryQ.Mill, span = smooth.span))
summaryQ.Mill$sm.00 <- predict(loess(p00~day.of.year, data = summaryQ.Mill, span = smooth.span))

#filtering to only have certain columns in the data table for 2018 - 2020 discharge
summaryQ.Mill <- select(summaryQ.Mill, Date, day.of.year,
                          sm.75, sm.25, sm.10, sm.05, sm.00) %>%
  filter(Date >= as.Date(paste0(current.year-1,"-01-01")))

#filtering to only have latest years in one dataframe (2018 - 2019 data)
latest.years.Mill <- dailyQ.30.avg.Mill %>%
  filter(Date >= as.Date(paste0(current.year-1,"-01-01"))) %>%
  mutate(day.of.year = 1:nrow(.))

#info for site 06892513
mid.month.days <- c(15, 45, 74, 105, 135, 166, 196, 227, 258, 288, 319, 349)
month.letters <- c("J","F","M","A","M","J","J","A","S","O","N","D")
start.month.days <- c(1, 32, 61, 92, 121, 152, 182, 214, 245, 274, 305, 335)
label.text <- c("Normal","Drought Watch","Drought Warning","Drought Emergency")

title.text.Mill <- paste0(stationInfo.Mill$station_nm,"\n",
                            "Record Start = ", min(dailyQ.30.avg.Mill$Date),
                            "  Number of years = ",
                            as.integer(as.numeric(difftime(time1 = max(dailyQ.30.avg.Mill$Date), 
                                                           time2 = min(dailyQ.30.avg.Mill$Date),
                                                           units = "weeks"))/52.25),
                            "\nDate of plot = ",Sys.Date(),
                            "  Drainage Area = ",stationInfo.Mill$drain_area_va, "mi^2")


#plotting low flow data and intervals 

drought.plot.Mill <- ggplot(data = summaryQ.Mill, aes(x = day.of.year)) +
  geom_ribbon(aes(ymin = sm.25, ymax = sm.75, fill = "Normal")) +
  geom_ribbon(aes(ymin = sm.10, ymax = sm.25, fill = "Drought Watch")) +
  geom_ribbon(aes(ymin = sm.05, ymax = sm.10, fill = "Drought Warning")) +
  geom_ribbon(aes(ymin = sm.00, ymax = sm.05, fill = "Drought Emergency")) +
  scale_y_log10(limits = c(1, 1000)) +
  geom_line(data = latest.years.Mill, aes(x=day.of.year, 
                                            y=rM, color = "30-Day Mean"),size=2) + #plotting 7-day mean for 2018-2019
  geom_vline(xintercept = 365) 

print(drought.plot.Mill)


#plotting a better plot for Mill River
styled.plot.Mill <- drought.plot.Mill +
  scale_x_continuous(breaks = c(mid.month.days, 365+mid.month.days),
                     labels = rep(month.letters, 2),
                     expand = c(0, 0),
                     limits = c(0,731)) +
  annotation_logticks(sides = "l") +
  expand_limits(x = 0) +
  annotate(geom = "text", 
           x = c(182,547), 
           y = 1, 
           label = c(current.year-1, current.year), size = 4) +
  theme_bw() + 
  theme(axis.ticks.x = element_blank(),
        panel.grid.major = element_blank(), 
        panel.grid.minor = element_blank()) +
  ggtitle(title.text.Mill) +
  labs(list(title = title.text.Mill),
       y = "30-day moving average", x = "Month") +
  scale_fill_manual(name = "", breaks = label.text,
                    values = c("red","orange","yellow","darkgreen")) +
  scale_color_manual(name = "", values = "black") +
  theme(legend.position="bottom")

print(styled.plot.Mill)
```

## Question 3: What factors contribute to the variability of total nitrogen in the rivers?

In order to better understand what contributes to the variability of nitrogen concentration in our study area of interest, we created a linear model with fixed effects and random effects. By considering the HUC 4 region each site is in as a random effect, we can estimate the amount of variation of nitrogen between each HUC 4. In order to better model the interaction, I chose to divide the year variable by 10 and the population by 1000 so that rescaling is not an issue. The model chosen is below:

> `lmer(data, log(total.nitrogen) ~ Year + population  + (1|huc4))`

Year and population are fixed effects while the grouping of the HUC 4 region is a random effect. This means we take the HUC 4 region variance into account when modeling the effect of year and population on total nitrogen. Using log transformed nitrogen data and HUC 4 region as a random effect, there is a significant difference in total nitrogen across each decade and every 1000 people (p < 2e-16). The regression equation is below:

$$log(Total Nitrogen) = -3.68 + 0.0229(Year/10) - 9.95e-04(population/1000)$$

Because we used a log transformed data set, we have to exponentiate the coefficients in the model to interpret them. The intercept is 0.025, which is the mean of total nitrogen when year is 0 and population is 0. When exponentiating the Year coefficient, we can conclude that every decade has a 1.02 multiplicative effect on nitrogen. When exponentiating the population coefficient, we can conclude that every 1000 people have a 0.99 multiplicative effect on nitrogen. The model demonstrates the the level of decade and population affected the total nitrogen in each HUC 4 region. Residuals are evenly distributed, and the R^2 value = 0.514, indicating that 51.4% of the variation in nitrogen is explained by this model.

## Question 4: Given past and current data, what can we predict about the future state of water in the Missouri River Basin?

### Discharge Trends Analysis
We also analyzed discharge trend at 22 sites using daily value data and Mann-Kandall Trend Test. The results are listed in the following table (Table 6). In our analysis, discharge of 18 sites increases while 4 sites show the decreasing trend of discharge. However, these four sites all locate in HUC 1025 and 1026, away from the main stem of the Missouri River. Therefore, overall, the discharge in Missouri River is increasing.

\newpage
Table: Discharge Trend over Time

NO.    |   Site Number   |  Discharge Trend  |  Discharge Trend Significance  |
:-------------:|:-----------------:|:-------------------:|:--------------------------------:|
1  |  06768000  |  Increase  |    |
2  |  06805500  |  Increase  |  ***  |
3  |  06775900  |  Increase  |  ***  |
4  |  06794000  |  Increase  |    |
5  |  06800000  |  Increase  |  ***  |
6  |  06800500  |  Increase  |  ***  |
7  |  06610000  |  Increase  |  ***  |
8  |  06609500  |  Increase  |  ***  |
9  |  06810000  |  Increase  |  ***  |
10  |  06818000  |  Increase  |  ***  |
11  |  06844500  |  Decrease  |  ***  |
12  |  06856600  |  Decrease  |  **  |
13  |  06877600  |  Decrease  |    |
14  |  06874000  |  Decrease  |  .  |
15  |  06887500  |  Increase  |    |
16  |  06892350  |  Increase  |  .  |
17  |  06902000  |  Increase  |  *  |
18  |  06905500  |  Increase  |  *  |
19  |  06921070  |  Increase  |    |
20  |  06926510  |  Increase  |    |
21  |  06894000  |  Increase  |  **  |
22  |  06934500  |  Increase  |  ***  |

Note:

'***' p-value < 0.001 

'**' 0.001 <= p-value < 0.01

'*' 0.01 <= p-value < 0.05 

'.' 0.05 <= p-value < 0.1 

otherwise  0.1 <= p-value < 1 


### Discharge Prediction
As discussed in Question 2, both severe drought and flooding events occurred in the basin in the past, which caused fatal damage to local agriculture. Therefore, it is important to make accurate forecasts of discharge, providing data support to policymakers.

We employed Autoregressive and Moving Average Models (ARMA) to effectively forecast into the future. The ARMA model is a tool for understanding and predicting future values in a time series. The AR part involves regressing the variable on its own lagged (i.e., past) values. The MA part involves modeling the error term as a linear combination of error terms occurring contemporaneously and at various times in the past. By using the discharge measurement data in the past and the ARMA model, we make a one-year discharge prediction for every site (Table 7). 

Table: One-year Discharge Prediction for Every Site 

No.    |   Site Number   |  Dec. 2019  | Jan. 2020  |  Feb. 2020  |  Mar. 2020  |  Apr. 2020  |  May 2020  |
:-----:|:-------------:|:-------------:|:------------:|:-------------:|:-------------:|:-------------:|:------------:|
1  |  06768000  |  2019.992	 |  1942.129	 |  1929.816 	|  2040.176	 |  2032.186	 |  1990.873	 |
2  |  06805500  |  14060.7	 |  12802.25	 |  12845.87	 |  23729.49	 |  15056.78	 |  16585.16	 |
3  |  06775900  |  239.2089	 |  238.9801	 |  238.3116	 |  239.5916	 |  240.5232	 |  242.5456	 |
4  |  06794000  |  148.0349	 |  129.4563	 |  129.6965	 |  327.3795	 |   165.0577	 |  190.15	 |
5  |  06800000  |  173.1581	 |  150.6924	 |  141.7451 	|  313.545	 |  159.0779	 |  199.5598 	|
6  |  06800500  |  2607.337	 |  2598.611	 |  2672.196	 |  3208.066	 |  3341.665	 |  3977.717	 |
7  |  06610000  |  70976.66	 |  60591.76	 |  55874.04	 |  73723.59	 |  81113.53	 |  83595.71	 |
8  |  06609500  |  708.6843	 |  691.4817	 |  645.5966	 |  1176.8041	 |  714.8702	 |  814.9989	 |
9  |  06810000  |  2422.32	 |  2391.721	 |  2377.854	 |  3204.073	 |  2417.139	 |  2731.861	 |
10  |  06818000  |  90011.3	 |  77760.16	 |  70549.03	 |   116938.26	 |  110927.07	 |  130362.46	 |
11  |  06844500  |  154.9544	 |  145.2851	 |  147.9408	 |  228.2876	 |  171.8784	 |  166.0301	 |
12  |  06856600  |  2212.686	 |  2012.946	 |  1966.35	 |  2354.776	 |  2052.399	 |  2615.569	 |
13  |  06877600  |  1999.598	 |  1814.097	 |  1688.58	 |  1807.765	 |  1634.919	 |  2308.793	 |
14  |  06874000  |  174.3205	 |  140.6582	 |  123.4546	 |  114.6624	 |  110.1691	 |  107.8727	 |
15  |  06887500  |  14398.77	 |  10484.501	 |  7784.95	 |  6938.432	 |  5800.966	 |  7571.298	 |
16  |  06892350  |  17433.744	 |  13064.978 	|  10272.795	 |  9334.909	 |  7730.841	 |  11531.101	 |
17  |  06902000  |  9634.729	 |  9456.489	 |  10440.135	 |  10753.103	 |  9392.489	 |  12326.771	 |
18  |  06905500  |  1946.371	 |  2523.677	 |  2663.863	 |  2701.267	 |  2556.851	 |  3142.349	 |
19  |  06921070  |  302.1977	 |  290.1968	 |  335.3464	 |  317.8665	 |  267.6631	 |  404.104	 |
20  |  06926510  |  12184.39	 |  13730.31	 |  13039.62	 |  12564.56	 |  14026.34	 |  14174.23	 |
21  |  06894000  |  181.6666	 |  206.4976	 |  203.7249 	|  206.7256	 |  214.5459	 |  320.4555	 |
22  |  06934500  |  189461.2	 |  194893.2	 |  194212.8	 |  215398.5	 |  212735.9	 |  230589.3	 |
(To be continue)


No.    |   Site Number   |  June 2020  |   July 2020  |  Aug. 2020  |  Sept. 2020  | Oct. 2020  | Nov. 2020  |
:-----:|:-------------:|:-------------:|:------------:|:-------------:|:-------------:|:-------------:|:------------:|
1  |  06768000  |  2023.824	 |  2008.55	 |  1928.585	 |  1996.895	 |  1979.38	 |  2026.699  |
2  |  06805500  |  18430.86	 |  15168.09	 |  15216.99	 |  14719.46	 |  13635.78	 |  12780.16  |
3  |  06775900  |  242.0369	 |  241.6409	 |  242.0486	 |  242.2389	 |  241.9548	 |  240.2764  |
4  |  06794000  |  189.022	 |  172.7318	 |   157.0474	 |  146.7917	 |  151.0374	 |  136.0562  |
5  |  06800000  |  187.1167	 |  149.6114	 |  148.6135	 |  149.6721	 |  146.2639	 |  136.3859  |
6  |  06800500  |  3785.948	 |  2912.286	 |  2434.121	 |  3091.355	 |  2733.932	 |  2520.393  |
7  |  06610000  |  90800.91	 |  85219.7	 |  78593.88	 |  80467.92	 |  78227.7	 |  70854.33  |
8  |  06609500  |  800.516	 |  733.6069	 |  650.3337	 |  655.3034	 |  724.2999	 |  689.9273  |
9  |  06810000  |  3004.86	 |  2650.792	 |  2460.292	 |  2777.403	 |  3156.369	 |  2595.649  |
10  |  06818000  | 131671.16	 |  110560.74	 |  99105.45	 |  103960.49	 |  121688.94	 |  96803.96 |
11  |  06844500  |  184.0507	 |  321.3987	 |  164.3744	 |  150.4602	 |  149.7053	 |  158.701  |
12  |  06856600  |  2571.786	 |  2483.559	 |  2404.832	 |  2283.906	 |  2196.924	 |  2058.036  |
13  |  06877600  |  2034.465 	|  1885.749	 |  1831.551	 |  1777.794	 |  1663.053	 |  1556.348  |
14  |  06874000  |  106.6991	 |  106.0993	 |  105.7928	 |  105.6361	 |  105.556	 |  105.5151  |
15  |  06887500  |  8326.411	 |  9052.989	 |  6796.397	 |  6676.547	 |  6316.088	 |  7646.2  |
16  |  06892350  |  11710.275	 |  12100.027	 |  10099.463	 |  9499.502	 |  8509.621	 |  9945.916  |
17  |  06902000  |  11756.818 	|  9390.933	 |  9517.493	 |  10274.174	 |  12340.875	 |  9446.777  |
18  |  06905500  |  2904.042	 |  2597.213	 |  2511.393	 |  2678.037	 |  2898.101	 |  2629.494  |
19  |  06921070  |  262.339	 |  255.1629	 |  247.3837	 |  250.4061	 |  269.6108	 |  277.8386  |
20  |  06926510  |  16191.64	 |  16801.49	 |  15671.6	 |  14122.26	 |  13155.48	 |  12236.42  |
21  |  06894000  |  220.6817	 |  228.4371	 |  209.8449	 |  231.759	 |  198.792	 |  190.647  |
22  |  06934500  |  240828.8	 |  227848.5 	|  213285.9	 |  216789.6	 |  230480	 |  210515  |

\newpage

# Summary and Conclusions
<Summarize your major findings from your analyses in a few paragraphs. What conclusions do you draw from your findings? Relate your findings back to the original research questions and rationale.>

\newpage

# References

